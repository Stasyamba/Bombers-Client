<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009"
         xmlns:s="library://ns.adobe.com/flex/spark"
         xmlns:mx="library://ns.adobe.com/flex/mx"
         xmlns:leftpanel="components.pages.game.leftpanel.*"
         creationComplete="init();"
         height="444" width="106">

    <fx:Declarations>
        <!-- Place non-visual elements (e.g., services, value objects) here -->
    </fx:Declarations>

    <fx:Script>
		<![CDATA[
        import com.smartfoxserver.v2.entities.User

        import engine.games.GameType
        import engine.profiles.LobbyProfile

        private var players:Array = new Array();

        private function deletePlayer(playerId:int):void {
            var el:PlayerSlot;
            el = playersGroup.getChildAt(playerId - 1) as PlayerSlot;
            el.removePlayer();
        }

        private function addPlayer(newProfile:LobbyProfile, playerId:int):void {
            if (newProfile == null)
                return;

            var el:PlayerSlot;
            el = playersGroup.getChildAt(playerId - 1) as PlayerSlot;
            el.setPlayer(newProfile);
        }

        private function setReady(isReady:Boolean, playerId:int):void {
            var el:PlayerSlot;
            el = playersGroup.getChildAt(playerId - 1) as PlayerSlot;
            el.isReady = isReady;
        }


        private function init():void {
            Context.gameModel.connectedToGame.add(onConnectedToGame)
            Context.gameServer.someoneJoinedToGame.add(onSomeoneJoinedToGame)
            Context.gameServer.someoneLeftGame.add(onSomeoneLeftGame)
            Context.gameModel.playerReadyChanged.add(onReadyChanged)
            Context.gameModel.threeSecondsToStart.add(onThreeSecondsToStart)

            Context.gameServer.leftGame.add(onLeftGame)
            Context.gameModel.readyToPlayAgain.add(onReadyToPlayAgain)
            onConnectedToGame()
        }

        private function onReadyToPlayAgain():void {
            if (Context.gameModel.gameType == GameType.REGULAR) {
                onConnectedToGame()
            }
        }

        private function onThreeSecondsToStart(p1:*, p2:*):void {
            for (var j:int = 1; j < 5; j++) {
                setReady(false, j)
            }
        }

        private function onLeftGame():void {
            for (var j:int = 1; j < 5; j++) {
                setReady(false,j)
                deletePlayer(j)
            }
        }

        private function onConnectedToGame():void {
            if (Context.gameModel.gameType == GameType.REGULAR) {
                onSomeoneJoinedToGame()
                if (Context.gameModel.createdByMe) {
                    Context.Model.dispatchCustomEvent(ContextEvent.GPAGE_NEED_TO_SHOW_GAME_IS_CREATED_WINDOW);
                } else {
                    Context.Model.dispatchCustomEvent(ContextEvent.GPAGE_NEED_TO_SHOW_GAME_READY_WINDOW);
                }
            }
        }

        private function onSomeoneLeftGame(user:User):void {
            setReady(false, user.playerId)
            deletePlayer(user.playerId)  //todo: check if playerId is still correct
        }

        private function onSomeoneJoinedToGame():void {
            for (var j:int = 1; j < 5; j++) {
                deletePlayer(j)
            }
            for each (var prof:LobbyProfile in Context.gameModel.lobbyProfiles) {
                if(prof != null)
                    addPlayer(prof, prof.playerId)
            }
            onReadyChanged()
        }

        private function onReadyChanged():void {
            for (var i:int = 1; i < 5; i++) {
                var lp:LobbyProfile = Context.gameModel.lobbyProfiles[i] as LobbyProfile
                if (lp != null) {
                    setReady(lp.isReady, i);
                }else{
                    deletePlayer(i)
                }
            }
        }
        ]]>
	</fx:Script>

    <s:BitmapImage source="@Embed(source='assets/pagegame/leftpanel/bg.jpg')"
                   height="444"
                   smooth="true">
        <s:filters>
            <s:DropShadowFilter distance="1"
                                alpha="0.85"
                                angle="0"
                                blurY="5"
                    />
        </s:filters>
    </s:BitmapImage>

    <s:VGroup width="104" height="444"
              verticalAlign="middle" horizontalAlign="center"
              gap="20"
              id="playersGroup"
            >

        <leftpanel:PlayerSlot id="player1"/>
        <leftpanel:PlayerSlot id="player2"/>
        <leftpanel:PlayerSlot id="player3"/>
        <leftpanel:PlayerSlot id="player4"/>

    </s:VGroup>

</s:Group>
